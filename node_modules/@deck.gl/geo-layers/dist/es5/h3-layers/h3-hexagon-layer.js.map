{"version":3,"sources":["../../../src/h3-layers/h3-hexagon-layer.js"],"names":["UPDATE_THRESHOLD_KM","getHexagonCentroid","getHexagon","object","objectInfo","hexagonId","lat","lng","h3ToPolygon","hexId","vertices","refLng","pt","deltaLng","defaultProps","Object","assign","PolygonLayer","highPrecision","coverage","type","min","max","value","x","hexagon","extruded","getColor","H3HexagonLayer","changeFlags","_shouldUseHighPrecision","propsOrDataChanged","somethingChanged","props","oldProps","dataChanged","updateTriggers","resolution","hasPentagon","data","iterable","index","setState","edgeLengthKM","UNITS","km","_updateVertices","context","viewport","state","centerHex","hex","latitude","longitude","pixelsPerMeter","distanceScales","centerLat","centerLng","projectFlat","centerX","centerY","map","p","worldPosition","_renderPolygonLayer","_renderColumnLayer","elevationScale","fp64","material","wireframe","stroked","filled","lineWidthUnits","lineWidthScale","lineWidthMinPixels","lineWidthMaxPixels","getFillColor","getElevation","getLineColor","getLineWidth","SubLayerClass","getSubLayerClass","forwardProps","_getForwardProps","getPolygon","getSubLayerProps","id","ColumnLayer","getPosition","diskResolution","radius","bind","CompositeLayer","layerName"],"mappings":"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","sourcesContent":["import {\n  h3ToGeoBoundary,\n  h3GetResolution,\n  h3ToGeo,\n  geoToH3,\n  h3IsPentagon,\n  h3Distance,\n  edgeLength,\n  UNITS\n} from 'h3-js';\nimport {CompositeLayer, createIterable} from '@deck.gl/core';\nimport {ColumnLayer, PolygonLayer} from '@deck.gl/layers';\n\n// There is a cost to updating the instanced geometries when using highPrecision: false\n// This constant defines the distance between two hexagons that leads to \"significant\n// distortion.\" Smaller value makes the column layer more sensitive to viewport change.\nconst UPDATE_THRESHOLD_KM = 10;\n\nfunction getHexagonCentroid(getHexagon, object, objectInfo) {\n  const hexagonId = getHexagon(object, objectInfo);\n  const [lat, lng] = h3ToGeo(hexagonId);\n  return [lng, lat];\n}\n\nfunction h3ToPolygon(hexId) {\n  const vertices = h3ToGeoBoundary(hexId, true);\n  const refLng = vertices[0][0];\n  for (const pt of vertices) {\n    const deltaLng = pt[0] - refLng;\n    if (deltaLng > 180) {\n      pt[0] -= 360;\n    } else if (deltaLng < -180) {\n      pt[0] += 360;\n    }\n  }\n  return vertices;\n}\n\nconst defaultProps = Object.assign({}, PolygonLayer.defaultProps, {\n  highPrecision: false,\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  getHexagon: {type: 'accessor', value: x => x.hexagon},\n  extruded: true,\n  getColor: null\n});\n\n/**\n * A subclass of HexagonLayer that uses H3 hexagonIds in data objects\n * rather than centroid lat/longs. The shape of each hexagon is determined\n * based on a single \"center\" hexagon, which can be selected by passing in\n * a center lat/lon pair. If not provided, the map center will be used.\n *\n * Also sets the `hexagonId` field in the onHover/onClick callback's info\n * objects. Since this is calculated using math, hexagonId will be present\n * even when no corresponding hexagon is in the data set. You can check\n * index !== -1 to see if picking matches an actual object.\n */\nexport default class H3HexagonLayer extends CompositeLayer {\n  shouldUpdateState({changeFlags}) {\n    return this._shouldUseHighPrecision()\n      ? changeFlags.propsOrDataChanged\n      : changeFlags.somethingChanged;\n  }\n\n  updateState({props, oldProps, changeFlags}) {\n    if (\n      changeFlags.dataChanged ||\n      (changeFlags.updateTriggers && changeFlags.updateTriggers.getHexagon)\n    ) {\n      let resolution = -1;\n      let hasPentagon = false;\n      const {iterable, objectInfo} = createIterable(props.data);\n      for (const object of iterable) {\n        objectInfo.index++;\n        const hexId = props.getHexagon(object, objectInfo);\n        // Take the resolution of the first hex\n        resolution = resolution < 0 ? h3GetResolution(hexId) : resolution;\n        if (h3IsPentagon(hexId)) {\n          hasPentagon = true;\n          break;\n        }\n      }\n      this.setState({\n        resolution,\n        edgeLengthKM: resolution >= 0 ? edgeLength(resolution, UNITS.km) : 0,\n        hasPentagon,\n        vertices: null\n      });\n    }\n\n    this._updateVertices(this.context.viewport);\n  }\n\n  _shouldUseHighPrecision() {\n    const {resolution, hasPentagon} = this.state;\n    return this.props.highPrecision || hasPentagon || (resolution >= 0 && resolution <= 5);\n  }\n\n  _updateVertices(viewport) {\n    if (this._shouldUseHighPrecision()) {\n      return;\n    }\n    const {resolution, edgeLengthKM, centerHex} = this.state;\n    if (resolution < 0) {\n      return;\n    }\n    const hex = geoToH3(viewport.latitude, viewport.longitude, resolution);\n    if (\n      centerHex === hex ||\n      (centerHex && h3Distance(centerHex, hex) * edgeLengthKM < UPDATE_THRESHOLD_KM)\n    ) {\n      return;\n    }\n\n    const {pixelsPerMeter} = viewport.distanceScales;\n\n    let vertices = h3ToPolygon(hex);\n    const [centerLat, centerLng] = h3ToGeo(hex);\n\n    const [centerX, centerY] = viewport.projectFlat([centerLng, centerLat]);\n    vertices = vertices.map(p => {\n      const worldPosition = viewport.projectFlat(p);\n      worldPosition[0] = (worldPosition[0] - centerX) / pixelsPerMeter[0];\n      worldPosition[1] = (worldPosition[1] - centerY) / pixelsPerMeter[1];\n      return worldPosition;\n    });\n\n    this.setState({centerHex: hex, vertices});\n  }\n\n  renderLayers() {\n    return this._shouldUseHighPrecision() ? this._renderPolygonLayer() : this._renderColumnLayer();\n  }\n\n  _getForwardProps() {\n    const {\n      elevationScale,\n      fp64,\n      material,\n      extruded,\n      wireframe,\n      stroked,\n      filled,\n      lineWidthUnits,\n      lineWidthScale,\n      lineWidthMinPixels,\n      lineWidthMaxPixels,\n      // TODO - Deprecate getColor Prop in v8.0\n      getColor,\n      getFillColor,\n      getElevation,\n      getLineColor,\n      getLineWidth,\n      updateTriggers\n    } = this.props;\n\n    return {\n      elevationScale,\n      fp64,\n      extruded,\n      wireframe,\n      stroked,\n      filled,\n      lineWidthUnits,\n      lineWidthScale,\n      lineWidthMinPixels,\n      lineWidthMaxPixels,\n      material,\n      getElevation,\n      getFillColor: getColor || getFillColor,\n      getLineColor,\n      getLineWidth,\n      updateTriggers: {\n        getFillColor: updateTriggers.getColor || updateTriggers.getFillColor,\n        getElevation: updateTriggers.getElevation,\n        getLineColor: updateTriggers.getLineColor,\n        getLineWidth: updateTriggers.getLineWidth\n      }\n    };\n  }\n\n  _renderPolygonLayer() {\n    const {data, getHexagon, updateTriggers} = this.props;\n\n    const SubLayerClass = this.getSubLayerClass('hexagon-cell-hifi', PolygonLayer);\n    const forwardProps = this._getForwardProps();\n    forwardProps.updateTriggers.getPolygon = updateTriggers.getHexagon;\n\n    return new SubLayerClass(\n      forwardProps,\n      this.getSubLayerProps({\n        id: 'hexagon-cell-hifi',\n        updateTriggers: forwardProps.updateTriggers\n      }),\n      {\n        data,\n        getPolygon: (object, objectInfo) => {\n          const hexagonId = getHexagon(object, objectInfo);\n          return h3ToPolygon(hexagonId);\n        }\n      }\n    );\n  }\n\n  _renderColumnLayer() {\n    const {data, getHexagon, updateTriggers} = this.props;\n\n    const SubLayerClass = this.getSubLayerClass('hexagon-cell', ColumnLayer);\n    const forwardProps = this._getForwardProps();\n    forwardProps.updateTriggers.getPosition = updateTriggers.getHexagon;\n\n    return new SubLayerClass(\n      forwardProps,\n      this.getSubLayerProps({\n        id: 'hexagon-cell',\n        updateTriggers: forwardProps.updateTriggers\n      }),\n      {\n        data,\n        diskResolution: 6, // generate an extruded hexagon as the base geometry\n        radius: 1,\n        vertices: this.state.vertices,\n        getPosition: getHexagonCentroid.bind(null, getHexagon)\n      }\n    );\n  }\n}\n\nH3HexagonLayer.defaultProps = defaultProps;\nH3HexagonLayer.layerName = 'H3HexagonLayer';\n"],"file":"h3-hexagon-layer.js"}